# IRデータベース 詳細設計書 v1.1

> v1.0 からの主な変更点: コメント付 DDL・パーティションロック手順・OCR 多言語対応・監査ログ保持・DR（RPO/RTO）検証手順・エッジケーステストを追加。

---

## 1. テーブル定義 (DDL 完全版)

### 1.1 OLTP スキーマ

```sql
-- companies: 東証上場企業マスタ
CREATE TABLE companies (
    code_jpx    CHAR(4)  PRIMARY KEY, -- JPX 銘柄コード
    edinet_code CHAR(6),              -- EDINET コード
    ticker      VARCHAR(8),           -- 証券コード
    name_ja     TEXT      NOT NULL,   -- 会社名（日本語）
    sector      TEXT,                 -- 業種
    market      TEXT,                 -- 上場市場
    created_at  TIMESTAMPTZ DEFAULT now(),
    updated_at  TIMESTAMPTZ DEFAULT now()
);
COMMENT ON TABLE companies IS 'JPX 上場企業マスタ';

-- documents: IR 文書メタ（月次 RANGE パーティション）
CREATE TABLE documents (
    doc_id      VARCHAR(20) PRIMARY KEY,     -- EDINET/TDnet 共通 ID
    code_jpx    CHAR(4)   REFERENCES companies(code_jpx),
    source      VARCHAR(10)  NOT NULL,       -- 'EDINET' | 'TDnet'
    doc_type    VARCHAR(32)  NOT NULL,       -- 有報/短信 等
    pub_date    DATE         NOT NULL,       -- 公表日
    file_path   TEXT         NOT NULL,       -- Raw 保存パス
    sha256      CHAR(64)     NOT NULL UNIQUE,-- 重複検知用ハッシュ
    size_bytes  BIGINT       NOT NULL,       -- バイトサイズ
    xbrl_flag   BOOLEAN      DEFAULT FALSE,  -- XBRL 有無
    pdf_flag    BOOLEAN      DEFAULT FALSE,  -- PDF 有無
    inserted_at TIMESTAMPTZ  DEFAULT now()
) PARTITION BY RANGE (pub_date);
COMMENT ON TABLE documents IS 'IR 文書メタデータ';

-- facts: XBRL 明細（月次 RANGE パーティション）
CREATE TABLE facts (
    doc_id    VARCHAR(20) REFERENCES documents(doc_id),
    item      TEXT,                 -- 勘定科目名
    context   TEXT,                 -- コンテキスト（FY/FQ）
    unit      TEXT,                 -- 単位（JPY, shares 等）
    decimals  INTEGER,              -- 小数点桁数
    value     NUMERIC(20,6),        -- 値
    PRIMARY KEY (doc_id,item,context,unit)
) PARTITION BY RANGE (doc_id);
COMMENT ON TABLE facts IS 'XBRL 科目の長形式テーブル';

-- pdf_texts: OCR 結果（月次 RANGE パーティション）
CREATE TABLE pdf_texts (
    doc_id         VARCHAR(20) REFERENCES documents(doc_id),
    page_no        INTEGER,
    text           TEXT,
    avg_confidence REAL,                -- ページ平均信頼度 (0‑100)
    error_flag     BOOLEAN DEFAULT FALSE,
    error_type     VARCHAR(32),         -- 'low_conf' | 'password' | 'unknown'
    PRIMARY KEY (doc_id,page_no)
) PARTITION BY RANGE (doc_id);
COMMENT ON TABLE pdf_texts IS 'PDF ページ OCR テキスト';

-- audit_log: ETL & API 監査
CREATE TABLE audit_log (
    log_id  BIGSERIAL PRIMARY KEY,
    run_id  UUID       NOT NULL,
    ts      TIMESTAMPTZ DEFAULT now(),
    level   VARCHAR(8)  CHECK (level IN ('INFO','WARN','ERROR')),
    module  TEXT,
    action  TEXT,
    detail  JSONB
);
COMMENT ON TABLE audit_log IS 'ジョブ・API 監査ログ (保持365日)';
```

> **月次パーティション attach/drop 手順**\
> `LOCK TABLE documents IN SHARE MODE;` → `ALTER TABLE documents ATTACH PARTITION …` を実行し、他トランザクションとの衝突を回避。

### 1.2 OLAP & FTS

```sql
-- FTS マテビュー (変更なし) + UNIQUE INDEX
CREATE MATERIALIZED VIEW pdf_texts_fts AS
SELECT doc_id,
       to_tsvector('japanese', string_agg(text,' ')) AS tsv
FROM pdf_texts
WHERE error_flag IS FALSE
GROUP BY doc_id;
CREATE UNIQUE INDEX uq_pdf_texts_fts_doc ON pdf_texts_fts(doc_id);
CREATE INDEX idx_fts_tsv ON pdf_texts_fts USING GIN(tsv);
```

---

## 2. ETL ランナー (runner.py)

変更なし: run\_id, inclusive step range, audit logging。\
**パーティションメンテ** は `partition_roll` ステップで月初 01:00 JST に実行し、前述の SHARE LOCK を適用。

---

## 3. OCR パイプライン (改訂)

| ステップ        | 変更点                                               |
| ----------- | ------------------------------------------------- |
| ① unlock    | `pikepdf` でパスワード解除失敗 → error\_type='password'     |
| ② convert   | `pdfplumber` → PNG 300 dpi                        |
| ③ recognize | `pytesseract`, `lang=jpn+eng+kor+chi_sim` オプション追加 |
| ④ parall.   | `multiprocessing.Pool(os.cpu_count())`            |
| ⑤ postproc  | avg\_confidence <70 → error\_flag=true            |

---

## 4. 監査・ログ保持

- **Retention Policy**: `audit_log` は 366 日経過レコードを nightly purge (`DELETE WHERE ts < now() - interval '366 days'`).
- GDPR/個人情報: 取得データは全て公開 IR、PII を含まず。

---

## 5. 災害復旧 (DR)

| 指標      | 目標値    |
| ------- | ------ |
| **RPO** | ≤ 24 h |
| **RTO** | ≤ 4 h  |

### 5.1 復旧検証手順 (月次)

1. `docker compose stop pg_main` でサービス停止
2. 最新 `pg_basebackup` + WAL で別ディレクトリに復元
3. `pg_isready` で起動確認、`SELECT count(*)` 対比
4. 検証ログを `audit_log` にレコード (`action='dr_test'`)

---

## 6. テストマトリクス (追加)

| 種別       | ケース            | 成功基準                                 |
| -------- | -------------- | ------------------------------------ |
| **Edge** | 断片化 PDF (画像のみ) | OCR avg\_conf ≤50 → error\_flag=true |
| Edge     | 200 MB 超 XBRL  | Parse 完了 & facts 行 > 0               |

---

## 7. 付録

- `scripts/partition_maintenance.sql` – 月次パーティション作成 & SHARE LOCK 付き
- `docs/runbook.md` – アラート対応・手動再実行・DR 手順
- `make er` – schemacrawler で ER 図自動生成

---

*以上*

