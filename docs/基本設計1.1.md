# IRデータベース 基本設計書 v1.1

**発行日:** 2025‑06‑24\
**改訂:** v1.0 → v1.1（ネットワーク境界・JWT 運用・エラー経路補足 等）

---

## 1. アーキテクチャ概要

```mermaid
flowchart TD
    subgraph Sources
        A[EDINET API] -->|ZIP/XBRL| B[Downloader]
        C[Yanoshin TDnet API] -->|JSON/PDF| B
        DTD[TDnet HTML CSV] -->|PDF| B
    end
    B --> Q[Retry Queue]
    B --> D[/data/raw/YYYY/MM/DD/sha/]
    Q -->|re‑try| B
    D --> E[Parser Layer\n(XBRL & OCR)]
    E --> F[(PostgreSQL OLTP)]
    F --> |logical replica| G[(PostgreSQL OLAP)]
    F --> H[FastAPI REST]
    E --> I[Prometheus Metrics]
    classDef retry fill:#ffcccc
    class Q retry
```

*赤破線はリトライ経路を示す。*

### 1.1 コンテナ / ネットワーク

| サービス        | イメージ                              | ポート  | ボリューム            | Network              |
| ----------- | --------------------------------- | ---- | ---------------- | -------------------- |
| pg\_main    | postgres:16                       | 5432 | ./pgdata/main    | `ir_net` (internal)  |
| pg\_replica | postgres:16                       | 5433 | ./pgdata/replica | `ir_net` (internal)  |
| etl         | python:3.12-slim                  | —    | ./data           | `ir_net` (internal)  |
| api         | tiangolo/uvicorn-gunicorn-fastapi | 8000 | —                | `ir_net` + published |
| exporter    | custom etl\_exporter              | 9100 | —                | `ir_net` (internal)  |

Docker network `ir_net` は `internal=true`。外部公開は api のみ (HTTP → Traefik / TLS 終端)。

## 2. データモデル更新

- **索引設計**: documents.pub\_date + sha256, facts.(item,unit) でクエリ最適化。
- **パーティションキー混在**: `pub_date` で time-series pruning、`doc_id` でファンアウト防止。

## 3. バッチ & スケジュール

| ジョブ              | エンジン           | 並列度   | リトライ        | アラート          |
| ---------------- | -------------- | ----- | ----------- | ------------- |
| `ir_daily_flow`  | cron → Prefect | CPU×2 | 2 回 (5 min) | Slack webhook |
| `partition_roll` | cron 月次        | —     | 無           | —             |

## 4. セキュリティ設計

- **JWT 鍵管理**: 256‑bit HS256、Vault で 90 日 rotate、旧鍵は 30 日読込許可。
- **TLS**: 自己署名 → 将来 CloudFront ACM。
- **アクセス制御**: ufw → 192.168.0.0/24 allow, 0.0.0.0/0 deny。

## 5. 監視 & 運用

- **Prometheus Rules**: `etl_success_total{status="error"} > 0 for 10m` → Slack。
- **Runbook**: docs/runbook.md に手動再実行・復元フローを定義。

## 6. ロードマップ (抜粋)

| Qtr    | 追加機能                   |
| ------ | ---------------------- |
| 2025Q3 | ESG 統合報告書 PDF/XBRL 取込  |
| 2025Q4 | GCP Cloud Run への移行 PoC |

---

*以上*

